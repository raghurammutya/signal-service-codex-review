#!/usr/bin/env python3
"""
Archive instrument_registry_experiments Directory

Safely archives the experimental directory now that production migration is complete.
Preserves migration history while removing confusion about which service is active.
"""

import os
import shutil
import tarfile
from datetime import datetime
from pathlib import Path


def archive_experimental_directory():
    """Archive instrument_registry_experiments safely"""

    print("üóÇÔ∏è  Starting experimental directory archival...")

    # Define paths
    experimental_dir = Path("/home/stocksadmin/instrument_registry_experiments")
    production_dir = Path("/home/stocksadmin/instrument_registry")
    archive_base = Path("/home/stocksadmin/.archived_experiments")
    backup_file = f"instrument_registry_experiments_backup_{datetime.now().strftime('%Y%m%d_%H%M%S')}.tar.gz"

    # Step 1: Verify production service is operational
    if not production_dir.exists():
        print("‚ùå Production directory not found - cannot safely archive experimental")
        return False

    print(f"‚úÖ Production service verified at {production_dir}")

    # Step 2: Create backup archive
    if experimental_dir.exists():
        print(f"üì¶ Creating backup archive: {backup_file}")

        with tarfile.open(backup_file, "w:gz") as tar:
            tar.add(experimental_dir, arcname="instrument_registry_experiments")

        print(f"‚úÖ Backup created: {backup_file}")

        # Step 3: Create archive directory structure
        archive_base.mkdir(parents=True, exist_ok=True)

        # Step 4: Move experimental to archive location
        archive_location = archive_base / "instrument_registry_experiments"

        if archive_location.exists():
            print("‚ö†Ô∏è  Archive location exists, removing old archive...")
            shutil.rmtree(archive_location)

        print("üìÅ Moving experimental directory to archive...")
        shutil.move(str(experimental_dir), str(archive_location))

        # Step 5: Create informational symlink
        symlink_path = Path("/home/stocksadmin/instrument_registry_experiments")
        if not symlink_path.exists():
            print("üîó Creating informational symlink...")
            os.symlink(str(archive_location), str(symlink_path))

        # Step 6: Create archive manifest
        manifest_content = f"""# instrument_registry_experiments Archive Manifest

## Archive Information
- **Archived Date:** {datetime.now().isoformat()}
- **Archive Location:** {archive_location}
- **Backup File:** {backup_file}
- **Production Service:** {production_dir}

## Archive Reason
Successfully migrated experimental instrument registry service to production.
Experimental directory archived to avoid confusion about which service is active.

## Contents Archived
- Complete experimental development environment
- Migration scripts and documentation
- Database schema evolution scripts
- Kubernetes manifests and deployment configs
- API scaffolding and prototype code

## Production Service Status
‚úÖ Production service operational at: {production_dir}
‚úÖ All migration completed successfully
‚úÖ No dependencies on archived experimental code

## Recovery Instructions
If experimental code is needed for reference:
```bash
# Access archived directory
cd {archive_location}

# Or restore from backup
tar -xzf {backup_file}
```

Generated by: archive_instrument_registry_experiments.py
"""

        manifest_file = archive_location / "ARCHIVE_MANIFEST.md"
        with open(manifest_file, 'w') as f:
            f.write(manifest_content)

        print(f"üìã Archive manifest created: {manifest_file}")
        print("‚úÖ Experimental directory successfully archived!")
        return True

    print("‚ÑπÔ∏è  Experimental directory not found - already archived or removed")
    return True

def update_cleanup_documentation():
    """Update cleanup documentation to reflect archival"""

    cleanup_plan_file = Path("/home/stocksadmin/signal-service-codex-review/LEGACY_CLEANUP_REMEDIATION_PLAN.md")

    if cleanup_plan_file.exists():
        with open(cleanup_plan_file) as f:
            content = f.read()

        # Add archival note
        archival_note = f"""

## ‚úÖ **UPDATE - Experimental Directory Archived**

**Date:** {datetime.now().strftime('%Y-%m-%d')}

The `instrument_registry_experiments` directory has been successfully archived to `/home/stocksadmin/.archived_experiments/` following successful production migration. All references below are now historical.

**Production Service Location:** `/home/stocksadmin/instrument_registry/`

---
"""

        # Insert after the first heading
        lines = content.split('\n')
        insert_index = 1
        for i, line in enumerate(lines):
            if line.startswith(("# ", "## ")):
                insert_index = i + 1
                break

        lines.insert(insert_index, archival_note)

        with open(cleanup_plan_file, 'w') as f:
            f.write('\n'.join(lines))

        print(f"üìù Updated cleanup documentation: {cleanup_plan_file}")

if __name__ == "__main__":
    success = archive_experimental_directory()
    if success:
        update_cleanup_documentation()
        print("\nüéâ Experimental directory archival complete!")
        print("‚úÖ Production service remains operational")
        print("üì¶ Migration history preserved in archive")
    else:
        print("\n‚ùå Archival failed - manual intervention required")
