name: Critical Modules 100% Coverage Gate

on:
  pull_request:
    branches: [ master, main ]
    paths:
      - 'app/services/**'
      - 'app/core/**'
      - 'tests/**'
  push:
    branches: [ master, main ]

jobs:
  critical-coverage-check:
    runs-on: ubuntu-latest
    
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      postgres:
        image: timescale/timescaledb:latest-pg14
        env:
          POSTGRES_PASSWORD: testpass
          POSTGRES_USER: testuser
          POSTGRES_DB: signal_service_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: 3.11

    - name: Cache Dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-test.txt
        
        # Install optional dependencies for full coverage
        pip install scipy scikit-learn findpeaks PyWavelets cvxpy networkx

    - name: Set Environment Variables
      run: |
        echo "ENVIRONMENT=test" >> $GITHUB_ENV
        echo "DATABASE_URL=postgresql://testuser:testpass@localhost:5432/signal_service_test" >> $GITHUB_ENV
        echo "REDIS_URL=redis://localhost:6379/0" >> $GITHUB_ENV
        echo "CONFIG_SERVICE_URL=http://localhost:8080" >> $GITHUB_ENV
        echo "CONFIG_SERVICE_API_KEY=test_key" >> $GITHUB_ENV

    - name: Run Database Migrations
      run: |
        python scripts/setup_test_db.py

    - name: Run Critical Modules Coverage Analysis
      run: |
        python scripts/coverage_analysis.py --fail-under-100
      env:
        PYTHONPATH: .

    # Add database coverage validation with 100% enforcement
    - name: Database Coverage Validation
      run: |
        python -m pytest tests/unit/test_database_session_coverage.py \
          --cov=common.storage.database \
          --cov=app.repositories \
          --cov-report=json:coverage_reports/database_coverage.json \
          --cov-fail-under=100
        
        echo "Database coverage validation completed with 100% requirement"
    
    # Database zero-gap validation
    - name: Database Zero-Gap Validation
      run: |
        python scripts/database_zero_gap_validation.py --fail-under-100
        echo "Database zero-gap validation completed"
    
    # Database failure mode testing
    - name: Database Failure Mode Testing
      run: |
        python -m pytest tests/integration/test_database_failure_modes.py \
          --cov=common.storage.database \
          --cov=app.repositories \
          --cov-report=json:coverage_reports/failure_mode_coverage.json \
          --cov-fail-under=95
        echo "Database failure mode testing completed"

    - name: Upload Coverage Reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: coverage-reports
        path: coverage_reports/
        retention-days: 30

    # Generate coverage badges for critical DB files  
    - name: Generate Database Coverage Badges
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      run: |
        # Critical database files coverage badges
        python scripts/coverage_analysis.py --per-module-badges \
          --modules common.storage.database,app.repositories.signal_repository,app.errors \
          --output coverage_reports/badges/
        
        # Generate coverage badge for README
        python scripts/generate_coverage_badge.py
    
    # Fail build if database coverage drops below 100%
    - name: Database Coverage Gate
      run: |
        DB_COVERAGE=$(python scripts/coverage_analysis.py --database-modules-only --numeric)
        echo "Database modules coverage: $DB_COVERAGE%"
        
        if (( $(echo "$DB_COVERAGE < 100" | bc -l) )); then
          echo "âŒ Database coverage ($DB_COVERAGE%) below required 100%"
          echo "Critical database modules must maintain 100% coverage"
          exit 1
        else
          echo "âœ… Database coverage ($DB_COVERAGE%) meets 100% requirement"
        fi

    - name: Comment Coverage Report on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const path = './coverage_reports/critical_modules_coverage_report.md';
          
          if (fs.existsSync(path)) {
            const report = fs.readFileSync(path, 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸŽ¯ Critical Modules Coverage Report\n\n${report}`
            });
          }

  regression-tests:
    runs-on: ubuntu-latest
    needs: critical-coverage-check
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: 3.11

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-test.txt

    - name: Run Regression Tests for Edge Cases
      run: |
        # Run specific regression tests for rare conditions
        python -m pytest tests/regression/ -v --tb=short
      env:
        ENVIRONMENT: test
        PYTHONPATH: .

    - name: Validate Production-like Deployment
      run: |
        python scripts/deployment_safety_validation.py
      env:
        ENVIRONMENT: production
        VALIDATE_CONTRACTS: true

  performance-validation:
    runs-on: ubuntu-latest
    needs: critical-coverage-check
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: 3.11

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-test.txt
        pip install locust  # For load testing

    - name: Run Performance Tests
      run: |
        # Test pandas_ta/pyvollib performance under load
        python tests/performance/test_pandas_ta_performance.py
        python tests/performance/test_pyvollib_performance.py
      env:
        ENVIRONMENT: test
        PYTHONPATH: .

    - name: Upload Performance Results
      uses: actions/upload-artifact@v3
      with:
        name: performance-results
        path: performance_results/