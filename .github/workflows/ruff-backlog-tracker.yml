name: Ruff Backlog Tracker

on:
  # Run nightly to track violation trends
  schedule:
    - cron: '0 2 * * *'  # 2 AM UTC daily
  # Allow manual triggering
  workflow_dispatch:
  # Run on main branch pushes to track progress
  push:
    branches: [ master, main ]

jobs:
  track-violations:
    runs-on: ubuntu-latest
    name: Track Violation Trends
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for trend analysis
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install ruff
        
    - name: Run violation triage
      run: |
        mkdir -p evidence/ruff_backlog
        python scripts/triage_ruff_violations.py --output-dir evidence/ruff_backlog
        
    - name: Generate trend data
      run: |
        # Create trend tracking file
        TIMESTAMP=$(date +%Y%m%d_%H%M%S)
        VIOLATIONS=$(ruff check . --exclude signal_service_legacy --statistics --quiet | wc -l)
        COMMIT_HASH=$(git rev-parse HEAD)
        COMMIT_MSG=$(git log -1 --pretty=%B)
        
        echo "{
          \"timestamp\": \"$TIMESTAMP\",
          \"commit\": \"$COMMIT_HASH\",
          \"total_violations\": $VIOLATIONS,
          \"commit_message\": \"$COMMIT_MSG\"
        }" > evidence/ruff_backlog/trend_$TIMESTAMP.json
        
    - name: Update backlog tracking
      run: |
        # Generate consolidated tracking report
        cat > evidence/ruff_backlog/current_status.md << EOF
        # Ruff Violation Backlog Status
        
        **Last Updated**: $(date -u)
        **Commit**: $(git rev-parse --short HEAD)
        
        ## Current Statistics
        \`\`\`
        $(ruff check . --exclude signal_service_legacy --statistics)
        \`\`\`
        
        ## Progress Tracking
        Target: < 5000 violations by end of sprint
        Current: $(ruff check . --exclude signal_service_legacy --statistics --quiet | wc -l) violations
        
        ## Sprint Goals
        - [ ] Fix all P0 critical violations (F821, F811, E999, F402)
        - [ ] Reduce P1 formatting violations by 50%
        - [ ] Complete import organization (I001, F401)
        - [ ] Implement exemption process for legacy files
        
        EOF
        
    - name: Commit tracking data
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "Ruff Backlog Tracker"
        
        if [ -n "$(git status --porcelain evidence/ruff_backlog/)" ]; then
          git add evidence/ruff_backlog/
          git commit -m "Update Ruff violation tracking

          Automated backlog tracking update
          Total violations: $(ruff check . --exclude signal_service_legacy --statistics --quiet | wc -l)
          
          ðŸ¤– Generated by Ruff Backlog Tracker" || echo "No changes to commit"
        fi
        
    - name: Upload tracking artifacts
      uses: actions/upload-artifact@v3
      with:
        name: ruff-backlog-tracking
        path: evidence/ruff_backlog/
        retention-days: 90

  create-issues:
    runs-on: ubuntu-latest
    name: Create GitHub Issues for High Priority Violations
    needs: track-violations
    if: github.event_name == 'schedule'  # Only on nightly runs
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install ruff requests
        
    - name: Check for critical violations
      id: critical-check
      run: |
        CRITICAL_COUNT=$(ruff check . --exclude signal_service_legacy --select F821,F811,E999,F402 --statistics --quiet | wc -l)
        echo "critical_count=$CRITICAL_COUNT" >> $GITHUB_OUTPUT
        
        if [ "$CRITICAL_COUNT" -gt 0 ]; then
          echo "has_critical=true" >> $GITHUB_OUTPUT
        else
          echo "has_critical=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Create critical violation issue
      if: steps.critical-check.outputs.has_critical == 'true'
      uses: actions/github-script@v6
      with:
        script: |
          const criticalCount = '${{ steps.critical-check.outputs.critical_count }}';
          
          const issueBody = `
          ## ðŸš¨ Critical Ruff Violations Detected
          
          **Violation Count**: ${criticalCount}
          **Priority**: P0 - IMMEDIATE
          **Impact**: Blocks merges and deployments
          
          ### Rules Affected
          - **F821**: undefined-name
          - **F811**: redefined-while-unused  
          - **E999**: syntax-error
          - **F402**: import-shadowed-by-loop-var
          
          ### Action Required
          \`\`\`bash
          # Identify violations
          ruff check . --select F821,F811,E999,F402 --exclude signal_service_legacy
          
          # Fix undefined names and syntax errors
          ruff check . --select F821,E999 --exclude signal_service_legacy --fix
          \`\`\`
          
          ### Acceptance Criteria
          - [ ] All F821 violations resolved
          - [ ] All syntax errors (E999) fixed  
          - [ ] Import shadowing (F402) addressed
          - [ ] Redefined variables (F811) cleaned up
          - [ ] CI pipeline passes without P0 violations
          
          **Auto-generated by Ruff Backlog Tracker**
          `;
          
          // Check if issue already exists
          const existingIssues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: ['ruff-critical', 'P0'],
            state: 'open'
          });
          
          if (existingIssues.data.length === 0) {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ P0: Fix ${criticalCount} Critical Ruff Violations`,
              body: issueBody,
              labels: ['ruff-critical', 'P0', 'bug', 'technical-debt']
            });
          } else {
            // Update existing issue
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: existingIssues.data[0].number,
              title: `ðŸš¨ P0: Fix ${criticalCount} Critical Ruff Violations`,
              body: issueBody
            });
          }
          
    - name: Check violation trends
      id: trend-check
      run: |
        # Simple trend check - compare with last week
        CURRENT=$(ruff check . --exclude signal_service_legacy --statistics --quiet | wc -l)
        
        # If violations increased significantly, create issue
        if [ "$CURRENT" -gt 7500 ]; then
          echo "trend_alert=true" >> $GITHUB_OUTPUT
          echo "current_count=$CURRENT" >> $GITHUB_OUTPUT
        else
          echo "trend_alert=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Create trend alert issue
      if: steps.trend-check.outputs.trend_alert == 'true'
      uses: actions/github-script@v6
      with:
        script: |
          const currentCount = '${{ steps.trend-check.outputs.current_count }}';
          
          const issueBody = `
          ## ðŸ“ˆ Ruff Violation Trend Alert
          
          **Current Count**: ${currentCount}
          **Threshold**: 7,500 violations
          **Status**: Above acceptable threshold
          
          ### Analysis Needed
          The violation count has exceeded our tracking threshold. This suggests:
          - New code introduced without linting checks
          - Regression in code quality standards
          - Need for immediate remediation sprint
          
          ### Recommended Actions
          1. **Immediate**: Run full auto-fix sweep
          2. **Short-term**: Assign P1/P2 violations to team members
          3. **Long-term**: Strengthen pre-commit hooks
          
          \`\`\`bash
          # Quick auto-fix for safe violations
          python scripts/run_ruff.py --fix
          
          # Generate detailed triage
          python scripts/triage_ruff_violations.py
          \`\`\`
          
          **Auto-generated by Ruff Backlog Tracker**
          `;
          
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ðŸ“ˆ Ruff Violation Count Alert: ${currentCount} violations`,
            body: issueBody,
            labels: ['ruff-trend', 'P1', 'technical-debt', 'process-improvement']
          });